#*
 * Copyright (C) 2015 Curity AB. All rights reserved.
 *
 * The contents of this file are the property of Curity AB.
 * You may not copy or use this file, in either source code
 * or executable form, except in compliance with terms
 * set by Curity AB.
 *
 * For further information, please contact Curity AB.
 *###
#*
 * For a full list of variables available in this template and their associated values, do the following:
 *
 * 1. Create a file called globals.vm in <installation-dir>/usr/share/templates/overrides/fragments
 *
 * 2. Add the following to this new file:
 *
 * <!--
 *    All variables:
 *    #foreach ($entry in $_context.entrySet())
 *        $entry.key => $!entry.value
 *    #end
 * -->
 *
 * 3. Request this template again and view the HTML source code. All variables and their values will be shown in an
 *    HTML comment at the top of the file.
 *
 * For more information about using the Velocity templating language, refer to
 * http://velocity.apache.org/engine/devel/user-guide.html.
 *###
#if(!$_postmessage)
    #set($_postmessage = '"authenticating"')
#end
<script type="text/javascript" $!nonceAttr>
    ## Are we framed? If so, the anti-click-jacking script in base/header.vm will pop us out of this unless the framer
    ## is trusted. Therefore, * as the target origin of the postMessage call is safe. Also keep in mind that we're only
    ## telling those that recieve this message that we're starting authentication.
    if (self !== top) {
        parent.postMessage($_postmessage, "*");
        document.addEventListener('keydown', function(evt) {
            evt = evt || window.event;
            var isEscape = false;
            if ("key" in evt) {
                isEscape = (evt.key === "Escape" || evt.key === "Esc");
            } else {
                isEscape = (evt.keyCode === 27);
            }
            if (isEscape) {
                parent.postMessage("Escape", "*");
            }
        });
    }
</script>
